set -e

bundle_cmd=/var/vcap/packages/ruby/bin/bundle
mysqlclient_dir=/var/vcap/packages/mysqlclient
libpq_dir=/var/vcap/packages/libpq

cd ${BOSH_INSTALL_TARGET}
cp -a ${BOSH_COMPILE_TARGET}/uhuru-webui uhuru_webui
cd ${BOSH_INSTALL_TARGET}/uhuru_webui

$bundle_cmd config build.mysql2 --with-mysql-dir=$mysqlclient_dir --with-mysql-include=$mysqlclient_dir/include/mysql
$bundle_cmd config build.pg --with-pg-lib=$libpq_dir/lib --with-pg-include=$libpq_dir/include
$bundle_cmd config build.sqlite3 --with-sqlite3-dir=/var/vcap/packages/sqlite

$bundle_cmd install --local --deployment --without development test

cd ${BOSH_INSTALL_TARGET}
cp -a ${BOSH_COMPILE_TARGET}/tools/router_registrar router_registrar
cd ${BOSH_INSTALL_TARGET}/router_registrar
$bundle_cmd install --local --deployment --without development test

